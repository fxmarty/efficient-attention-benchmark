Benchmark run on A100 between a PyTorch eager implementation of attention, `flash_attn_unpadded_qkvpacked_func` from [HazyResearch/flash-attention](https://github.com/HazyResearch/flash-attention), and [`torch.nn.functional.scaled_dot_product_attention`](https://pytorch.org/docs/master/generated/torch.nn.functional.scaled_dot_product_attention.html) from PyTorch nightlies.

Note: The comparison with HazyResearch implementation happens to be unfair, as  `scaled_dot_product_attention` does under the hood the same kind of pre-processing as HazyResearch, merging q/k/v, that was not measured in this benchmark: https://github.com/fxmarty/efficient-attention-benchmark/blob/35c9c4cc07b724dbc18c2ac06f658933303a3e51/benchmark.py#L28-L45

## Specs

* PyTorch: 2.1.0.dev20230306+cu117
* flash-attn: commit 57ee618170e1adecbf787365cdf330c63768abd2
* GPU: one NVIDIA A100-SXM4-80GB

## Forward benchmark

|bs|seqlen|headdim|nheads|PT eager (ms/forward)|PT native (ms/forward)|Hazy (ms/forward)|Hazy speedup over `scaled_dot_product_attention`|
|----------|-------|-------|------|---------------------|----------------------|-------------------------|----------------------------------------------|
|8         |64     |32     |12    |0.112                |0.052                 |0.042                    |1.251                                         |
|8         |64     |32     |16    |0.106                |0.053                 |0.048                    |1.109                                         |
|8         |64     |32     |24    |0.110                |0.054                 |0.049                    |1.104                                         |
|8         |64     |64     |12    |0.110                |0.056                 |0.045                    |1.250                                         |
|8         |64     |64     |16    |0.106                |0.058                 |0.044                    |1.308                                         |
|8         |64     |64     |24    |0.103                |0.065                 |0.037                    |1.791                                         |
|8         |64     |128    |12    |0.105                |0.061                 |0.038                    |1.592                                         |
|8         |64     |128    |16    |0.107                |0.061                 |0.043                    |1.418                                         |
|8         |64     |128    |24    |0.108                |0.060                 |0.038                    |1.597                                         |
|8         |128    |32     |12    |0.105                |0.058                 |0.044                    |1.307                                         |
|8         |128    |32     |16    |0.111                |0.059                 |0.045                    |1.319                                         |
|8         |128    |32     |24    |0.110                |0.051                 |0.038                    |1.358                                         |
|8         |128    |64     |12    |0.107                |0.063                 |0.035                    |1.776                                         |
|8         |128    |64     |16    |0.109                |0.058                 |0.040                    |1.475                                         |
|8         |128    |64     |24    |0.101                |0.057                 |0.040                    |1.432                                         |
|8         |128    |128    |12    |0.110                |0.064                 |0.041                    |1.578                                         |
|8         |128    |128    |16    |0.108                |0.090                 |0.049                    |1.842                                         |
|8         |128    |128    |24    |0.139                |0.131                 |0.050                    |2.634                                         |
|8         |256    |32     |12    |0.122                |0.050                 |0.031                    |1.607                                         |
|8         |256    |32     |16    |0.139                |0.056                 |0.041                    |1.372                                         |
|8         |256    |32     |24    |0.206                |0.100                 |0.040                    |2.515                                         |
|8         |256    |64     |12    |0.129                |0.083                 |0.040                    |2.082                                         |
|8         |256    |64     |16    |0.192                |0.100                 |0.031                    |3.194                                         |
|8         |256    |64     |24    |0.245                |0.172                 |0.056                    |3.085                                         |
|8         |256    |128    |12    |0.180                |0.146                 |0.122                    |1.203                                         |
|8         |256    |128    |16    |0.228                |0.183                 |0.136                    |1.344                                         |
|8         |256    |128    |24    |0.384                |0.319                 |0.230                    |1.383                                         |
|8         |512    |32     |12    |0.371                |0.125                 |0.052                    |2.408                                         |
|8         |512    |32     |16    |0.503                |0.151                 |0.061                    |2.477                                         |
|8         |512    |32     |24    |0.632                |0.229                 |0.108                    |2.115                                         |
|8         |512    |64     |12    |0.395                |0.194                 |0.105                    |1.849                                         |
|8         |512    |64     |16    |0.498                |0.232                 |0.123                    |1.891                                         |
|8         |512    |64     |24    |0.731                |0.382                 |0.252                    |1.518                                         |
|8         |512    |128    |12    |0.498                |0.428                 |0.300                    |1.425                                         |
|8         |512    |128    |16    |0.653                |0.523                 |0.375                    |1.392                                         |
|8         |512    |128    |24    |1.003                |0.910                 |0.705                    |1.290                                         |
|8         |1024   |32     |12    |1.184                |0.390                 |0.218                    |1.788                                         |
|8         |1024   |32     |16    |1.550                |0.478                 |0.308                    |1.552                                         |
|8         |1024   |32     |24    |2.314                |0.833                 |0.433                    |1.923                                         |
|8         |1024   |64     |12    |1.316                |0.568                 |0.377                    |1.505                                         |
|8         |1024   |64     |16    |1.735                |0.734                 |0.465                    |1.579                                         |
|8         |1024   |64     |24    |2.610                |1.254                 |0.822                    |1.526                                         |
|8         |1024   |128    |12    |1.656                |1.360                 |1.183                    |1.150                                         |
|8         |1024   |128    |16    |2.143                |1.781                 |1.532                    |1.162                                         |
|8         |1024   |128    |24    |3.089                |2.707                 |2.554                    |1.060                                         |
|16        |64     |32     |12    |0.121                |0.066                 |0.035                    |1.896                                         |
|16        |64     |32     |16    |0.116                |0.057                 |0.039                    |1.461                                         |
|16        |64     |32     |24    |0.106                |0.044                 |0.043                    |1.027                                         |
|16        |64     |64     |12    |0.107                |0.055                 |0.040                    |1.376                                         |
|16        |64     |64     |16    |0.106                |0.047                 |0.032                    |1.477                                         |
|16        |64     |64     |24    |0.103                |0.059                 |0.050                    |1.177                                         |
|16        |64     |128    |12    |0.112                |0.062                 |0.037                    |1.705                                         |
|16        |64     |128    |16    |0.109                |0.118                 |0.030                    |3.874                                         |
|16        |64     |128    |24    |0.128                |0.153                 |0.044                    |3.453                                         |
|16        |128    |32     |12    |0.110                |0.073                 |0.034                    |2.116                                         |
|16        |128    |32     |16    |0.103                |0.060                 |0.050                    |1.200                                         |
|16        |128    |32     |24    |0.158                |0.065                 |0.041                    |1.578                                         |
|16        |128    |64     |12    |0.105                |0.057                 |0.040                    |1.420                                         |
|16        |128    |64     |16    |0.135                |0.090                 |0.037                    |2.414                                         |
|16        |128    |64     |24    |0.188                |0.124                 |0.035                    |3.550                                         |
|16        |128    |128    |12    |0.134                |0.133                 |0.051                    |2.614                                         |
|16        |128    |128    |16    |0.179                |0.149                 |0.052                    |2.837                                         |
|16        |128    |128    |24    |0.275                |0.226                 |0.113                    |2.007                                         |
|16        |256    |32     |12    |0.210                |0.097                 |0.042                    |2.290                                         |
|16        |256    |32     |16    |0.269                |0.115                 |0.034                    |3.337                                         |
|16        |256    |32     |24    |0.387                |0.169                 |0.052                    |3.280                                         |
|16        |256    |64     |12    |0.244                |0.143                 |0.056                    |2.543                                         |
|16        |256    |64     |16    |0.330                |0.187                 |0.060                    |3.140                                         |
|16        |256    |64     |24    |0.476                |0.268                 |0.117                    |2.289                                         |
|16        |256    |128    |12    |0.379                |0.314                 |0.231                    |1.355                                         |
|16        |256    |128    |16    |0.499                |0.399                 |0.258                    |1.544                                         |
|16        |256    |128    |24    |0.698                |0.633                 |0.401                    |1.579                                         |
|16        |512    |32     |12    |0.666                |0.255                 |0.137                    |1.868                                         |
|16        |512    |32     |16    |0.853                |0.301                 |0.139                    |2.171                                         |
|16        |512    |32     |24    |1.263                |0.499                 |0.251                    |1.985                                         |
|16        |512    |64     |12    |0.770                |0.383                 |0.232                    |1.651                                         |
|16        |512    |64     |16    |0.981                |0.496                 |0.289                    |1.716                                         |
|16        |512    |64     |24    |1.476                |0.736                 |0.438                    |1.681                                         |
|16        |512    |128    |12    |0.978                |0.886                 |0.673                    |1.316                                         |
|16        |512    |128    |16    |1.315                |1.097                 |0.834                    |1.315                                         |
|16        |512    |128    |24    |2.011                |1.640                 |1.252                    |1.311                                         |
|16        |1024   |32     |12    |2.333                |0.812                 |0.444                    |1.826                                         |
|16        |1024   |32     |16    |3.019                |0.987                 |0.597                    |1.654                                         |
|16        |1024   |32     |24    |4.608                |1.559                 |0.906                    |1.721                                         |
|16        |1024   |64     |12    |2.651                |1.255                 |0.791                    |1.588                                         |
|16        |1024   |64     |16    |3.437                |1.481                 |0.982                    |1.509                                         |
|16        |1024   |64     |24    |5.282                |2.258                 |1.529                    |1.477                                         |
|16        |1024   |128    |12    |3.150                |2.712                 |2.461                    |1.102                                         |
|16        |1024   |128    |16    |4.190                |3.664                 |3.228                    |1.135                                         |
|16        |1024   |128    |24    |6.157                |5.308                 |4.874                    |1.089                                         |
|64        |64     |32     |12    |0.107                |0.092                 |0.027                    |3.428                                         |
|64        |64     |32     |16    |0.129                |0.117                 |0.034                    |3.448                                         |
|64        |64     |32     |24    |0.170                |0.148                 |0.045                    |3.288                                         |
|64        |64     |64     |12    |0.153                |0.130                 |0.042                    |3.083                                         |
|64        |64     |64     |16    |0.196                |0.176                 |0.055                    |3.174                                         |
|64        |64     |64     |24    |0.332                |0.233                 |0.101                    |2.312                                         |
|64        |64     |128    |12    |0.223                |0.217                 |0.097                    |2.234                                         |
|64        |64     |128    |16    |0.307                |0.308                 |0.143                    |2.156                                         |
|64        |64     |128    |24    |0.442                |0.440                 |0.193                    |2.282                                         |
|64        |128    |32     |12    |0.249                |0.142                 |0.043                    |3.336                                         |
|64        |128    |32     |16    |0.297                |0.181                 |0.057                    |3.157                                         |
|64        |128    |32     |24    |0.452                |0.290                 |0.115                    |2.525                                         |
|64        |128    |64     |12    |0.369                |0.230                 |0.101                    |2.287                                         |
|64        |128    |64     |16    |0.468                |0.310                 |0.138                    |2.245                                         |
|64        |128    |64     |24    |0.701                |0.472                 |0.219                    |2.153                                         |
|64        |128    |128    |12    |0.566                |0.467                 |0.191                    |2.441                                         |
|64        |128    |128    |16    |0.712                |0.628                 |0.320                    |1.964                                         |
|64        |128    |128    |24    |1.072                |0.882                 |0.363                    |2.429                                         |
|64        |256    |32     |12    |0.791                |0.322                 |0.175                    |1.838                                         |
|64        |256    |32     |16    |1.001                |0.472                 |0.213                    |2.216                                         |
|64        |256    |32     |24    |1.408                |0.634                 |0.344                    |1.844                                         |
|64        |256    |64     |12    |0.923                |0.513                 |0.242                    |2.120                                         |
|64        |256    |64     |16    |1.230                |0.688                 |0.355                    |1.936                                         |
|64        |256    |64     |24    |1.850                |0.993                 |0.466                    |2.132                                         |
|64        |256    |128    |12    |1.307                |1.125                 |0.652                    |1.724                                         |
|64        |256    |128    |16    |1.764                |1.507                 |0.895                    |1.684                                         |
|64        |256    |128    |24    |2.573                |2.084                 |1.258                    |1.656                                         |
|64        |512    |32     |12    |2.456                |0.952                 |0.533                    |1.787                                         |
|64        |512    |32     |16    |3.383                |1.235                 |0.646                    |1.911                                         |
|64        |512    |32     |24    |4.970                |1.746                 |0.929                    |1.878                                         |
|64        |512    |64     |12    |2.888                |1.410                 |0.782                    |1.804                                         |
|64        |512    |64     |16    |4.025                |1.873                 |1.092                    |1.714                                         |
|64        |512    |64     |24    |5.807                |2.673                 |1.525                    |1.753                                         |
|64        |512    |128    |12    |4.005                |3.222                 |2.473                    |1.303                                         |
|64        |512    |128    |16    |5.135                |4.164                 |3.265                    |1.275                                         |
|64        |512    |128    |24    |7.908                |6.160                 |4.768                    |1.292                                         |
|64        |1024   |32     |12    |9.167                |2.834                 |1.792                    |1.582                                         |
|64        |1024   |32     |16    |12.346               |3.701                 |2.367                    |1.564                                         |
|64        |1024   |32     |24    |18.261               |5.586                 |3.648                    |1.531                                         |
|64        |1024   |64     |12    |10.397               |4.314                 |2.998                    |1.439                                         |
|64        |1024   |64     |16    |13.884               |5.774                 |3.979                    |1.451                                         |
|64        |1024   |64     |24    |20.953               |8.356                 |5.869                    |1.424                                         |
|64        |1024   |128    |12    |12.442               |10.513                |9.131                    |1.151                                         |
|64        |1024   |128    |16    |16.654               |14.036                |12.500                   |1.123                                         |
|64        |1024   |128    |24    |25.053               |20.593                |18.381                   |1.120                                         |

## Benchmark forward + backward

|bs|seqlen|headdim|nheads|PT eager (ms/forward)|PT native (ms/forward)|PT Native speedup|
|----------|-------|-------|------|---------------------|----------------------|--------------|
|8         |64     |32     |12    |0.789                |0.300                 |2.631         |
|8         |64     |32     |16    |0.557                |0.296                 |1.885         |
|8         |64     |32     |24    |0.569                |0.300                 |1.895         |
|8         |64     |64     |12    |0.557                |0.301                 |1.851         |
|8         |64     |64     |16    |0.564                |0.294                 |1.920         |
|8         |64     |64     |24    |0.562                |0.294                 |1.909         |
|8         |64     |128    |12    |0.560                |0.311                 |1.800         |
|8         |64     |128    |16    |0.563                |0.297                 |1.893         |
|8         |64     |128    |24    |0.568                |0.296                 |1.920         |
|8         |128    |32     |12    |0.567                |0.296                 |1.916         |
|8         |128    |32     |16    |0.558                |0.293                 |1.906         |
|8         |128    |32     |24    |0.562                |0.294                 |1.915         |
|8         |128    |64     |12    |0.557                |0.293                 |1.900         |
|8         |128    |64     |16    |0.556                |0.294                 |1.894         |
|8         |128    |64     |24    |0.566                |0.297                 |1.905         |
|8         |128    |128    |12    |0.549                |0.294                 |1.869         |
|8         |128    |128    |16    |0.555                |0.299                 |1.855         |
|8         |128    |128    |24    |0.582                |0.346                 |1.685         |
|8         |256    |32     |12    |0.569                |0.302                 |1.881         |
|8         |256    |32     |16    |0.566                |0.294                 |1.923         |
|8         |256    |32     |24    |0.581                |0.298                 |1.946         |
|8         |256    |64     |12    |0.566                |0.304                 |1.863         |
|8         |256    |64     |16    |0.565                |0.332                 |1.701         |
|8         |256    |64     |24    |0.628                |0.414                 |1.517         |
|8         |256    |128    |12    |0.561                |0.430                 |1.305         |
|8         |256    |128    |16    |0.573                |0.602                 |0.952         |
|8         |256    |128    |24    |0.842                |0.825                 |1.020         |
|8         |512    |32     |12    |0.956                |0.408                 |2.344         |
|8         |512    |32     |16    |1.233                |0.610                 |2.023         |
|8         |512    |32     |24    |1.778                |0.779                 |2.284         |
|8         |512    |64     |12    |1.045                |0.584                 |1.791         |
|8         |512    |64     |16    |1.348                |0.875                 |1.540         |
|8         |512    |64     |24    |1.961                |1.141                 |1.718         |
|8         |512    |128    |12    |1.255                |1.141                 |1.099         |
|8         |512    |128    |16    |1.658                |1.595                 |1.039         |
|8         |512    |128    |24    |2.439                |2.280                 |1.070         |
|8         |1024   |32     |12    |3.332                |1.308                 |2.548         |
|8         |1024   |32     |16    |4.335                |1.599                 |2.711         |
|8         |1024   |32     |24    |6.425                |2.467                 |2.605         |
|8         |1024   |64     |12    |3.572                |1.783                 |2.004         |
|8         |1024   |64     |16    |4.721                |2.346                 |2.012         |
|8         |1024   |64     |24    |7.033                |3.491                 |2.014         |
|8         |1024   |128    |12    |4.173                |3.610                 |1.156         |
|8         |1024   |128    |16    |5.414                |4.735                 |1.143         |
|8         |1024   |128    |24    |8.074                |7.194                 |1.122         |
|16        |64     |32     |12    |0.601                |0.293                 |2.054         |
|16        |64     |32     |16    |0.546                |0.289                 |1.892         |
|16        |64     |32     |24    |0.543                |0.291                 |1.866         |
|16        |64     |64     |12    |0.546                |0.295                 |1.853         |
|16        |64     |64     |16    |0.588                |0.302                 |1.946         |
|16        |64     |64     |24    |0.546                |0.292                 |1.867         |
|16        |64     |128    |12    |0.552                |0.293                 |1.882         |
|16        |64     |128    |16    |0.552                |0.295                 |1.869         |
|16        |64     |128    |24    |0.552                |0.339                 |1.627         |
|16        |128    |32     |12    |0.548                |0.292                 |1.874         |
|16        |128    |32     |16    |0.549                |0.293                 |1.876         |
|16        |128    |32     |24    |0.555                |0.294                 |1.884         |
|16        |128    |64     |12    |0.550                |0.294                 |1.868         |
|16        |128    |64     |16    |0.548                |0.291                 |1.884         |
|16        |128    |64     |24    |0.552                |0.347                 |1.592         |
|16        |128    |128    |12    |0.559                |0.339                 |1.651         |
|16        |128    |128    |16    |0.554                |0.421                 |1.316         |
|16        |128    |128    |24    |0.581                |0.602                 |0.965         |
|16        |256    |32     |12    |0.570                |0.293                 |1.949         |
|16        |256    |32     |16    |0.731                |0.373                 |1.961         |
|16        |256    |32     |24    |1.037                |0.502                 |2.065         |
|16        |256    |64     |12    |0.644                |0.426                 |1.510         |
|16        |256    |64     |16    |0.835                |0.548                 |1.524         |
|16        |256    |64     |24    |1.199                |0.781                 |1.536         |
|16        |256    |128    |12    |0.852                |0.833                 |1.022         |
|16        |256    |128    |16    |1.109                |1.097                 |1.011         |
|16        |256    |128    |24    |1.606                |1.584                 |1.013         |
|16        |512    |32     |12    |1.795                |0.784                 |2.290         |
|16        |512    |32     |16    |2.342                |1.054                 |2.221         |
|16        |512    |32     |24    |3.450                |1.479                 |2.332         |
|16        |512    |64     |12    |1.968                |1.160                 |1.697         |
|16        |512    |64     |16    |2.586                |1.524                 |1.697         |
|16        |512    |64     |24    |3.811                |2.153                 |1.770         |
|16        |512    |128    |12    |2.428                |2.291                 |1.060         |
|16        |512    |128    |16    |3.227                |3.060                 |1.055         |
|16        |512    |128    |24    |4.782                |4.370                 |1.094         |
|16        |1024   |32     |12    |6.465                |2.451                 |2.638         |
|16        |1024   |32     |16    |8.551                |3.251                 |2.630         |
|16        |1024   |32     |24    |12.800               |4.573                 |2.799         |
|16        |1024   |64     |12    |7.043                |3.477                 |2.026         |
|16        |1024   |64     |16    |9.327                |4.686                 |1.990         |
|16        |1024   |64     |24    |14.034               |6.666                 |2.105         |
|16        |1024   |128    |12    |8.064                |7.231                 |1.115         |
|16        |1024   |128    |16    |10.717               |9.293                 |1.153         |
|16        |1024   |128    |24    |16.216               |14.050                |1.154         |
|64        |64     |32     |12    |0.597                |0.293                 |2.039         |
|64        |64     |32     |16    |0.552                |0.319                 |1.730         |
|64        |64     |32     |24    |0.554                |0.432                 |1.281         |
|64        |64     |64     |12    |0.550                |0.363                 |1.516         |
|64        |64     |64     |16    |0.555                |0.452                 |1.227         |
|64        |64     |64     |24    |0.615                |0.660                 |0.931         |
|64        |64     |128    |12    |0.554                |0.611                 |0.907         |
|64        |64     |128    |16    |0.649                |0.791                 |0.820         |
|64        |64     |128    |24    |0.984                |1.134                 |0.868         |
|64        |128    |32     |12    |0.662                |0.444                 |1.491         |
|64        |128    |32     |16    |0.818                |0.546                 |1.497         |
|64        |128    |32     |24    |1.167                |0.795                 |1.467         |
|64        |128    |64     |12    |0.843                |0.659                 |1.278         |
|64        |128    |64     |16    |1.086                |0.849                 |1.279         |
|64        |128    |64     |24    |1.559                |1.252                 |1.245         |
|64        |128    |128    |12    |1.222                |1.139                 |1.073         |
|64        |128    |128    |16    |1.580                |1.511                 |1.046         |
|64        |128    |128    |24    |2.308                |2.222                 |1.039         |
|64        |256    |32     |12    |2.046                |1.040                 |1.968         |
|64        |256    |32     |16    |2.623                |1.273                 |2.060         |
|64        |256    |32     |24    |3.835                |1.823                 |2.104         |
|64        |256    |64     |12    |2.293                |1.466                 |1.564         |
|64        |256    |64     |16    |3.015                |1.905                 |1.583         |
|64        |256    |64     |24    |4.455                |2.750                 |1.620         |
|64        |256    |128    |12    |3.137                |3.039                 |1.033         |
|64        |256    |128    |16    |4.165                |3.937                 |1.058         |
|64        |256    |128    |24    |6.155                |5.728                 |1.075         |
|64        |512    |32     |12    |6.758                |2.815                 |2.401         |
|64        |512    |32     |16    |9.037                |3.620                 |2.497         |
|64        |512    |32     |24    |13.465               |5.247                 |2.566         |
|64        |512    |64     |12    |7.496                |4.137                 |1.812         |
|64        |512    |64     |16    |9.952                |5.310                 |1.874         |
|64        |512    |64     |24    |15.059               |7.851                 |1.918         |
|64        |512    |128    |12    |9.449                |8.445                 |1.119         |
|64        |512    |128    |16    |12.643               |11.058                |1.143         |
|64        |512    |128    |24    |18.830               |16.518                |1.140         |
|64        |1024   |32     |12    |25.616               |8.892                 |2.881         |
|64        |1024   |32     |16    |34.264               |11.466                |2.988         |
|64        |1024   |32     |24    |51.215               |17.081                |2.998         |
|64        |1024   |64     |12    |28.024               |13.019                |2.153         |
|64        |1024   |64     |16    |37.398               |16.887                |2.215         |
|64        |1024   |64     |24    |55.981               |25.046                |2.235         |
|64        |1024   |128    |12    |32.176               |27.613                |1.165         |
|64        |1024   |128    |16    |42.856               |36.193                |1.184         |
|64        |1024   |128    |24    |64.304               |54.204                |1.186         |
